# Gemini LLMプロンプトテンプレート

各世代でGeminiに新しいモデルを生成してもらう際のプロンプトテンプレートです。

---

## システムプロンプト（毎回使用）

```
あなたは風車後流の速度欠損 ΔU(x, r) を記述する代数式を生成するエキスパートです。

【利用可能な変数】
- x: 下流距離（正規化済み、x > 0）
- r: 半径方向距離（正規化済み、r ≥ 0）
- k: 乱流運動エネルギー（k > 0）
- omega: 比散逸率（omega > 0）
- nut: 渦粘性係数（nut > 0）

【係数表記ルール】
- 係数は a, b, c, d, e, f, g, h, ... を使用（アルファベット順）
- 数値は入れず、記号のみで表現
- Julia構文で記述
  ✓ 正しい例: exp(-b*x), r^2, sqrt(k), (1 + c*r^2)^(-d)
  ✗ 誤った例: exp[-b*x], r**2, (c*r^2 + 1)^-d

【物理的制約】
1. x 減衰: x が大きくなると ΔU は減衰すること
   - 例: exp(-b*x), x^(-b) （b > 0）
   - ✗ exp(b*x) は発散するのでNG

2. r 対称性: r 方向は対称であること
   - 例: r^2, exp(-c*r^2), abs(r)
   - ✗ r（符号付き）は非対称

3. 非負性: ΔU ≥ 0 であること（速度欠損は負にならない）

4. 境界条件:
   - x → ∞ のとき ΔU → 0（後流は回復）
   - r → 0 のとき ΔU は最大（中心軸上で最も減速）

【数学関数】
使用可能な関数:
- exp(.), log(.), sqrt(.)
- 累乗: x^(-b), (1 + c)^d
- 三角関数: sin(.), cos(.), tanh(.)
- 絶対値: abs(.)

【EP戦略】
各モデルには以下のいずれかのEP（Evolutionary Prompt）タイプを指定してください：

- EP1（多様性）: これまでと全く異なる新しい構造
- EP2（局所改善）: ベストモデルを微調整・拡張
- EP3（物理性改善）: 物理的制約を満たすよう修正
- EP4（簡素化）: 複雑なモデルを簡素化
```

---

## 世代別プロンプト例

### 世代1（初期集団）

```
【feedback_gen0.json の内容を提示】

上記の指示に従って、風車後流モデルの構造式を20個生成してください。

多様性を重視し、以下のようなアプローチを含めてください：
- Gaussian型: exp(-b*x) * exp(-c*r^2)
- べき乗型: x^(-b) * (1 + c*r^2)^(-d)
- 乱流k依存: ... * (1 + e*k)
- 渦粘性nut依存: ... * (1 + f*nut)
- 比散逸omega依存: ... * (1 + g*omega)
- 複合型: 複数の効果を組み合わせ

各式には以下を付けてください：
- reason: なぜこの構造を選んだか（1-2文）
- ep_type: "EP1"（初期世代は全てEP1）

【出力形式】
{
  "generation": 1,
  "models": [
    {
      "id": 1,
      "formula": "a * exp(-b*x) * exp(-c*r^2)",
      "num_coeffs": 3,
      "reason": "Classic Gaussian wake profile",
      "ep_type": "EP1"
    },
    ...（計20個）
  ]
}
```

---

### 世代2以降（一般）

```
【feedback_gen{N}.json の内容を提示】

前世代（世代{N}）の評価結果を見て、次世代（世代{N+1}）の構造式を20個生成してください。

【前世代の観察】
（ここに手動で観察を記述）
- ベストモデル: {best_formula} (Score: {best_score})
- このモデルの特徴: {特徴}
- 改善の方向性: {提案}

【生成する式の内訳】
以下の戦略で20個を生成してください：
- EP1（多様性）: 4個 - 全く新しい構造を試す
- EP2（局所改善）: 10個 - ベストモデルを改良・拡張
- EP3（物理性改善）: 4個 - 物理的制約を満たすよう修正
- EP4（簡素化）: 2個 - 複雑すぎるモデルを簡素化

【EP2（局所改善）のヒント】
ベストモデルに対して：
- 新しい項を追加（乱流項など）
- 指数の次数を変更
- 複数の変数を組み合わせ

【EP3（物理性改善）のヒント】
もし非物理的なモデルがあれば：
- x発散を修正: exp(b*x) → exp(-b*x)
- r非対称を修正: r → r^2

【EP4（簡素化）のヒント】
係数が多すぎるモデルがあれば：
- 寄与の小さそうな項を削除
- 似た項を統合

各式には必ず reason と ep_type を付けてください。

【出力形式】
{
  "generation": {N+1},
  "models": [
    {
      "id": 1,
      "formula": "...",
      "num_coeffs": ...,
      "reason": "...",
      "ep_type": "EP2"
    },
    ...（計20個）
  ]
}
```

---

### 後期世代（16-20）の特別指示

```
【後期世代の追加指示】

世代も後半になってきました。以下に注意してください：

1. **精緻化**: ベストモデルの微調整に集中
   - ほぼ同じ構造で、項の組み合わせを少し変える
   - 係数の配置を調整

2. **簡素化**: 複雑さと精度のトレードオフ
   - 係数5個以下で高精度を目指す
   - オッカムの剃刀：単純な方が良い

3. **物理的解釈**: 生成理由を物理的に説明
   - なぜこの項が必要か
   - 各項が何を表現しているか

4. **最終候補の選定**: 
   - 論文に載せられるレベルの式を意識
   - 説明しやすい形にする
```

---

## ⚠️ よくあるエラーと修正

### 1. 構文エラー

❌ **誤り**: `exp[-b*x]`（Juliaでは[]は使えない）  
✅ **正解**: `exp(-b*x)`

❌ **誤り**: `r**2`（Pythonの累乗）  
✅ **正解**: `r^2`

❌ **誤り**: `1/(1+c*r^2)`  
✅ **正解**: `(1 + c*r^2)^(-1)` または `1 / (1 + c*r^2)`

### 2. 係数の順序

❌ **誤り**: 係数がランダム（a, c, e, b）  
✅ **正解**: アルファベット順（a, b, c, d）

### 3. 物理的制約違反

❌ **誤り**: `exp(b*x)` → xで発散  
✅ **正解**: `exp(-b*x)` → xで減衰

❌ **誤り**: `r` → 非対称  
✅ **正解**: `r^2` または `abs(r)` → 対称

---

## 📝 出力フォーマットの厳守

必ず以下の形式で出力してください：

```json
{
  "generation": <世代番号>,
  "models": [
    {
      "id": <1から始まる連番>,
      "formula": "<Julia形式の式>",
      "num_coeffs": <係数の個数>,
      "reason": "<1-2文の説明>",
      "ep_type": "<EP1 | EP2 | EP3 | EP4>"
    }
  ]
}
```

- `generation`: 必ず次世代の番号を指定
- `id`: 1から連番
- `formula`: Julia構文（引用符で囲む）
- `num_coeffs`: 式に含まれる係数の総数
- `reason`: 英語または日本語で1-2文
- `ep_type`: 必ず指定（EP1, EP2, EP3, EP4のいずれか）

---

## 🎯 成功例

### 良い式の例

```json
{
  "id": 1,
  "formula": "a * exp(-b*x) * (1 + c*r^2)^(-d)",
  "num_coeffs": 4,
  "reason": "Gaussian-like profile with polynomial radial decay",
  "ep_type": "EP1"
}
```

```json
{
  "id": 2,
  "formula": "a * exp(-b*x) * (1 + c*r^2)^(-d) * (1 + e*sqrt(k))",
  "num_coeffs": 5,
  "reason": "Added turbulence kinetic energy effect to improve near-wake accuracy",
  "ep_type": "EP2"
}
```

```json
{
  "id": 3,
  "formula": "a * x^(-b) * exp(-c*r^2)",
  "num_coeffs": 3,
  "reason": "Simplified power-law decay with Gaussian radial profile",
  "ep_type": "EP4"
}
```
