# Gemini LLMプロンプトテンプレート

各世代でGeminiに新しいモデルを生成してもらう際のプロンプトテンプレートです。

---

## システムプロンプト（毎回使用）

```
あなたは風車後流の速度欠損 ΔU(x, r) を記述する代数式を生成するエキスパートです。

【利用可能な変数】
- x: 下流距離（正規化済み、x > 0）
- r: 半径方向距離（正規化済み、r ≥ 0）
- k: 乱流運動エネルギー（k > 0）
- omega: 比散逸率（omega > 0）
- nut: 渦粘性係数（nut > 0）

【係数表記ルール】
- 係数は a, b, c, d, e, f, g, h, ... を使用（アルファベット順）
- 数値は入れず、記号のみで表現
- Julia構文で記述
  ✓ 正しい例: exp(-b*x), r^2, sqrt(k), (1 + c*r^2)^(-d)
  ✗ 誤った例: exp[-b*x], r**2, (c*r^2 + 1)^-d

【物理的制約】
1. x 減衰: x が大きくなると ΔU は減衰すること
   - 例: exp(-b*x), x^(-b) （b > 0）
   - ✗ exp(b*x) は発散するのでNG


2. 非負性: ΔU ≥ 0 であること（速度欠損は負にならない）

3. 境界条件:
   - x → ∞ のとき ΔU → 0（後流は回復）
   - r → 0 のとき ΔU は最大（中心軸上で最も減速）

【数学関数】
使用可能な関数:
- exp(.), log(.), sqrt(.)
- 累乗: x^(-b), (1 + c)^d
- 三角関数: sin(.), cos(.), tanh(.)
- 絶対値: abs(.)

【EP戦略】
各モデルには以下のいずれかのEP（Evolutionary Prompt）タイプを指定してください：

- EP1（多様性）: これまでと全く異なる新しい構造
- EP2（局所改善）: ベストモデルを微調整・拡張（主構造の改善に集中）
- EP3（物理性改善）: 物理的制約を満たすよう修正
- EP4（簡素化）: 複雑なモデルを簡素化
- EP5（記号的変異）: 数式演算子を直接変異させる（例: `+`→`*`, `exp`→`tanh`）
- EP6（交叉・組換え）: 2つの異なる良モデルの構造を組み合わせる（例: モデルAの減衰項 × モデルBの半径方向項）
- EP7（次元解析整合）: 次元の整合性を重視し、物理的に意味のある無次元数の組み合わせのみを使用
- EP8（極限境界テスト）: x→0, x→∞, r→∞ などの極限挙動が理論と一致することを最優先する
- EP9（アンサンブル/混合）: 異なる物理メカニズム（近接後流 + 遠方後流など）の重み付き和として表現
- EP10（予備）: 将来的な拡張用（現在は使用しない）
```

---

## 世代別プロンプト例

### 世代1（初期集団）

```
【feedback_gen0.json の内容を提示】

上記の指示に従って、風車後流モデルの構造式を20個生成してください。

多様性を重視し、以下のようなアプローチを含めてください：
- Gaussian型: exp(-b*x) * exp(-c*r^2)
- べき乗型: x^(-b) * (1 + c*r^2)^(-d)
- 乱流k依存: ... * (1 + e*k)
- 乱流k依存: ... * (1 + e*k)
- 渦粘性nut依存: ... * (1 + f*nut)
- 比散逸omega依存: ... * (1 + g*omega)
- 複合型: 複数の効果を組み合わせ
- **シードモデルの活用**: 提示された「過去の成功モデル（シード）」を参考に、それらを改良したり、異なるアプローチと組み合わせたりしてください。
- **注意**: この段階では主構造（減衰や広がり）の探索に集中してください。

各式には以下を付けてください：
- reason: なぜこの構造を選んだか（1-2文）
- ep_type: "EP1"（初期世代は全てEP1）

【出力形式】
{
  "generation": 1,
  "models": [
    {
      "id": 1,
      "formula": "a * exp(-b*x) * exp(-c*r^2)",
      "num_coeffs": 3,
      "reason": "Classic Gaussian wake profile",
      "ep_type": "EP1"
    },
    ...（計20個）
  ]
}
```

---

### 世代2以降（一般）

```
【feedback_gen{N}.json の内容を提示】

前世代（世代{N}）の評価結果を見て、次世代（世代{N+1}）の構造式を20個生成してください。

【前世代の観察】
（ここに手動で観察を記述）
- ベストモデル: {best_formula} (Score: {best_score})
- このモデルの特徴: {特徴}
- 改善の方向性: {提案}

【生成する式の内訳】
以下の戦略分布（Gen 2-15用）に従って20個を生成してください：

1. **Exploration (10個)**
   - EP1 (Diversity): 4個
   - EP5 (Mutation): 2個
   - EP6 (Crossover): 4個

2. **Exploitation (6個)**
   - EP2 (Local Improvement): 4個
   - EP9 (Ensemble): 2個

3. **Constraints (4個)**
   - EP3 (Physics): 2個
   - EP4 (Simplification): 1個
   - EP7 (Dimensional): 1個

**注意**: この段階（Gen 6-10）では、既存モデルの微調整よりも、新しい構造の発見（Exploration）を最優先してください。



【EP2（局所改善）のヒント】
ベストモデルに対して：
- 新しい項を追加（乱流項など）
- 指数の次数を変更
- 複数の変数を組み合わせ


【EP3（物理性改善）のヒント】
もし非物理的なモデルがあれば：
- x発散を修正: exp(b*x) → exp(-b*x)


【EP4（簡素化）のヒント】
係数が多すぎるモデルがあれば：
- 寄与の小さそうな項を削除
- 似た項を統合

各式には必ず reason, ep_type, そして改良元の親モデル情報（parent_generation, parent_id）を付けてください。
EP1の場合は親情報は `null` にしてください。

【出力形式】
{
  "generation": {N+1},
  "models": [
    {
      "id": 1,
      "formula": "...",
      "num_coeffs": ...,
      "reason": "...",
      "ep_type": "EP2",
      "parent_generation": N,
      "parent_id": 1
    },
    ...（計20個）
  ]
}
```

---

### 後期世代（16-20）の特別指示
 
 ```
 【後期世代の追加指示】
 
 世代も後半（Gen 16-20）になりました。ここでExploitation（徹底的な改善）にシフトします。
 以下の比率に変更してください：
 
 1. **Exploitation (12個)**
    - EP2 (Local Improvement): 8個
    - EP9 (Ensemble): 4個
 
 2. **Exploration (4個)**
    - EP1 (Diversity): 2個
    - EP6 (Crossover): 2個
 
 3. **Constraints (4個)**
    - EP3/4/7/8 (Mix): 4個
 
 1. **EP2（Improvement）の役割**: 
    - 既存の良モデルの主構造を徹底的に微調整する。
    - 係数の最適化だけでなく、項の微修正も含む。
 
 2. **EP9（Ensemble）の役割**: 
    - 複数の良モデルを組み合わせて、よりロバストなモデルを作る。
 
 3. **最終候補の選定**: 
    - 論文に載せられるレベルの式を意識
    - 物理的に妥当で、かつ説明しやすい形にする
 ```

---

## ⚠️ よくあるエラーと修正

### 1. 構文エラー

❌ **誤り**: `exp[-b*x]`（Juliaでは[]は使えない）  
✅ **正解**: `exp(-b*x)`

❌ **誤り**: `r**2`（Pythonの累乗）  
✅ **正解**: `r^2`

❌ **誤り**: `1/(1+c*r^2)`  
✅ **正解**: `(1 + c*r^2)^(-1)` または `1 / (1 + c*r^2)`

### 2. 係数の順序

❌ **誤り**: 係数がランダム（a, c, e, b）  
✅ **正解**: アルファベット順（a, b, c, d）

### 3. 物理的制約違反

❌ **誤り**: `exp(b*x)` → xで発散  
✅ **正解**: `exp(-b*x)` → xで減衰



---

## 📝 出力フォーマットの厳守

必ず以下の形式で出力してください：

```json
{
  "generation": <世代番号>,
  "models": [
    {
      "id": <1から始まる連番>,
      "formula": "<Julia形式の式>",
      "num_coeffs": <係数の個数>,
      "reason": "<1-2文の説明>",
      "ep_type": "<EP1 | EP2 | EP3 | EP4>"
    }
  ]
}
```

- `generation`: 必ず次世代の番号を指定
- `id`: 1から連番
- `formula`: Julia構文（引用符で囲む）
- `num_coeffs`: 式に含まれる係数の総数
- `reason`: 英語または日本語で1-2文
- `ep_type`: 必ず指定（EP1, EP2, EP3, EP4のいずれか）
- `parent_generation`: 改良元のモデルの世代（EP1はnull）
- `parent_id`: 改良元のモデルのID（EP1はnull）

---

## 🎯 成功例

### 良い式の例

```json
{
  "id": 1,
  "formula": "a * exp(-b*x) * (1 + c*r^2)^(-d)",
  "num_coeffs": 4,
  "reason": "Gaussian-like profile with polynomial radial decay",
  "ep_type": "EP1",
  "parent_generation": null,
  "parent_id": null
}
```

```json
{
  "id": 2,
  "formula": "a * exp(-b*x) * (1 + c*r^2)^(-d) * (1 + e*sqrt(k))",
  "num_coeffs": 5,
  "reason": "Added turbulence kinetic energy effect to improve near-wake accuracy",
  "ep_type": "EP2",
  "parent_generation": 1,
  "parent_id": 1
}
```

```json
{
  "id": 3,
  "formula": "a * x^(-b) * exp(-c*r^2)",
  "num_coeffs": 3,
  "reason": "Simplified power-law decay with Gaussian radial profile",
  "ep_type": "EP4",
  "parent_generation": 1,
  "parent_id": 2
}
```

---

## 2. 進化戦略（厳守）
停滞を防ぎ、多様な探索を確実にするため、**毎世代**（Gen 1を除く）以下の戦略分布を厳守してください：

### 戦略カテゴリ
1. **Exploration (探索)**: EP1, EP5, EP6
2. **Exploitation (活用)**: EP2, EP9
3. **Constraints (制約)**: EP3, EP4, EP7, EP8

### 分布表（Gen 2-15）
| 戦略タイプ | 個数 | 目的 |
| :--- | :--- | :--- |
| **Exploration** | **10** | EP1 (4), EP5 (2), EP6 (4) - 新しい構造、変異、交叉を試す。 |
| **Exploitation** | **6** | EP2 (4), EP9 (2) - ベストモデルの改良とアンサンブル。 |
| **Constraints** | **4** | EP3 (2), EP4 (1), EP7 (1) - 物理性の修正、簡素化、次元整合。 |

**重要:** EP2だけに集中しないでください。堅牢な進化のためにこのバランスを維持する必要があります。

### 分布表（Gen 16-20: 収束・微調整）
| 戦略タイプ | 個数 | 目的 |
| :--- | :--- | :--- |
| **Exploitation** | **12** | EP2 (8), EP9 (4) - 徹底的な微調整とアンサンブル。 |
| **Exploration** | **4** | EP1 (2), EP6 (2) - ブレイクスルーの可能性を残す。 |
| **Constraints** | **4** | EP3/4/7/8 (Mix) - 物理的妥当性の確保。 |

**Gen 16-20（収束と洗練）**
- **EP4 (簡素化)**: 係数が小さい項や影響の少ない項を削除。
- **EP6 (交叉)**: 性能の良い2つの親モデルの特徴を組み合わせる。
- **EP7 (次元解析)**: 次元の整合性を確保するよう項を調整（例: x/D）。
- **推奨戦略**: EP2, EP3, EP9。
- **禁止事項**: オフセット調整（定数項の追加）。

## 3. 入力データ

提供されるJSONファイル（例: `feedback_genX.json`）には以下が含まれます：
- `generation`: 現在の世代番号 $N$。
- `best_model`: 世代 $N$ のベストモデル。
- `statistics`: 集団の統計情報。
- `evaluated_models`: 世代 $N$ の全モデルリスト（スコアと理由付き）。

## 4. タスク

1.  **分析**: 世代 $N$ のフィードバックを分析し、どの構造が最も良かったか特定する。
2.  **決定**: 上記の「進化戦略」テーブルに基づいて、世代 $N+1$ の戦略を決定する。
3.  **生成**: 世代 $N+1$ 用に新しいモデル式を20個生成する。
4.  **出力**: 指定されたJSON形式で結果を出力する。

## 5. 出力フォーマット

必ず以下の形式で出力してください：

```json
{
  "generation": <世代番号>,
  "models": [
    {
      "id": <1から始まる連番>,
      "formula": "<Julia形式の式>",
      "num_coeffs": <係数の個数>,
      "reason": "<1-2文の説明>",
      "ep_type": "<EP1 | EP2 | EP3 | EP4>",
      "parent_generation": <親世代番号 | null>,
      "parent_id": <親ID | null>
    }
  ]
}
```

---

## 6. レポート作成プロンプト

実験終了後、最終レポートを作成する際は以下のプロンプトを使用してください。

```
【役割】
あなたは風力発電と流体力学の専門家です。提供された実験データとベンチマーク結果に基づいて、詳細な技術レポートを**日本語で**作成してください。

【入力データ】
（ここに report_context.md の内容を貼り付け）

【レポート構成】
以下のセクション構成で記述してください：

# 実験レポート: [実験名]

## 1. エグゼクティブサマリー
- 実験の目的と主な成果の要約。
- 最終的に発見されたベストモデルの性能（MSE）と、既存モデル（Jensen, Bastankhah）に対する改善率。
- 結論の簡潔なまとめ。

## 2. 方法論
- 進化計算（LLMSR）のアプローチの概要。
- 使用した戦略（探索と活用のバランス、物理制約の導入など）。
- 評価指標（MSE、物理ペナルティ）。

## 3. 結果分析
### 3.1 進化の履歴
- 世代ごとのスコア推移（初期から最終世代までの改善）。
- 探索されたモデル構造の多様性についての考察。

### 3.2 ベストモデルの特定
- 最終的に選定されたモデルの数式と係数。
- そのモデルが選ばれた理由（LLMの推論に基づく）。

## 4. 物理的解釈と議論
- 発見されたモデルの各項が持つ物理的な意味。
  - 減衰項（x依存性）の挙動。
  - 半径方向（r依存性）のプロファイル。
  - 乱流パラメータ（k, omega, nut）の影響（もし含まれていれば）。
- 既存の物理モデルとの類似点と相違点。

## 5. ベンチマーク比較
- JensenモデルおよびBastankhahモデルとの定量的な比較。
- 提案モデルが優れている点（近接後流の再現性、遠方後流の精度など）。

## 6. 結論と今後の展望
- 本実験の総括。
- 今後のモデル改良に向けた推奨事項（新たな変数の導入、探索範囲の拡大など）。

【注意点】
- 専門用語を適切に使用し、学術的なトーンで記述すること。
- 数式は $ ... $ 形式で記述し、可読性を高めること。
- 重要な数値（MSE、改善率）は強調すること。
```

---

## 7. 参考知識: 高度な後流モデル (Advanced Wake Models)

以下のモデル知識を、新しい構造式の提案に役立ててください。

### 1. Jensen-Gaussian モデル
Jensenモデルの線形拡大をベースにしつつ、速度分布をガウス関数で記述。
$$ u = U_0 - (U_0 - U_{\Delta}) \frac{5.16}{\sqrt{2\pi}} \exp\left(-\frac{r^2}{2 (r_x/2.58)^2}\right) $$
ここで $U_{\Delta}$ は中心速度欠損。

### 2. 2D Jensen-k モデル (Cosine)
速度欠損の分布にコサイン関数を使用。
$$ u = U_0 - U_{\Delta} \left[ \cos\left(\frac{\pi r}{r_x} + \pi\right) + 1 \right] $$
※ $r_x$ は後流半径。コサイン関数の半周期を超えると破綻する可能性に注意。

### 3. Curled Wake モデル
ヨー角を持つ風車からの反転回転渦（Counter-rotating vortices）を考慮。
Navier-Stokes方程式の簡略化に基づき、有効粘度 $\nu_{\text{eff}}$ を用いる。
$$ U \frac{\partial u'}{\partial x} \approx \nu_{\text{eff}} \nabla^2 u' $$
渦の減衰（Vortex Decay）や、Lamb-Oseen渦としての記述が含まれる。

### 4. Larsen モデル
RANS方程式を薄いせん断層近似で単純化。
$$ u_x(x, r) \propto \left[ r^{3/2} (x)^{-1/2} - C \right]^2 $$
Prandtlの混合長理論に基づく。

### 5. FUGA モデル
線形化されたRANS方程式に基づく。
渦粘性 $\nu_T = \kappa u_* z$ を使用し、圧力項も考慮。
物理的に厳密だが計算コストが高い。

**ヒント**:
これらのモデルから、「コサイン型プロファイル」や「渦粘性 $\nu_T$ への依存性」、「$x^{-1/2}$ のような減衰項」などのアイデアを取り入れることができます。

---

## 最終確認事項

トライアル終了時には、以下のスクリプトを必ず実行してレポートを生成してください：
1. `visualize_evolution.jl` - 進化の可視化（プロット生成）
2. `trace_evolution_lineage.jl` - 進化の系譜を追跡
3. `benchmark_models.jl` - 物理的妥当性と精度のベンチマーク
4. `prepare_report.jl` - 最終レポート (`report.md`) の生成

また、**`seeds.json` に今回のベストモデルを追加すること**を忘れないでください。

これらを忘れると、せっかくの発見が記録に残りません。
